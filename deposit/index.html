<!DOCTYPE html>
<html lang="en">

<head>
	<meta charset="UTF-8" />
	<title>MetaMask Sign Message Example with Two Fields</title>
	<style>
		/* Modern System Font Stack (Bootstrap 5 Default) */
		body {
			font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
			max-width: 90vw;
			margin: 2rem auto;
			padding: 0 1.5rem;
			background: #f8f9fa;
			box-sizing: border-box;
		}

		.main-container {
			width: 100%;
			max-width: 600px;
			margin: 0 auto;
			background: white;
			border-radius: 8px;
			box-shadow: 0 2px 4px rgba(0, 0, 0, .1);
			padding: 1.5rem;
		}

		.form-group {
			margin-bottom: 1.5rem;
		}

		label {
			display: block;
			margin-bottom: 0.75rem;
			color: #495057;
			font-weight: 500;
		}

		input {
			font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
			width: calc(600px - 2.5rem);
			padding: 0.875rem 1.25rem;
			border: 1px solid #e9ecef;
			border-radius: 4px;
			transition: border-color 0.15s ease-in-out;
			margin-bottom: 0.75rem;
		}

		input:focus {
			border-color: #94d82d;
			box-shadow: 0 0 0 3px rgba(148, 216, 45, 0.25);
			outline: 0;
		}

		button {
			font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
			width: 100%;
			padding: 0.75rem;
			margin-bottom: 0.75rem;
			background-color: #94d82d;
			color: white;
			border: none;
			border-radius: 8px;
			font-weight: 500;
			transition: all 0.2s cubic-bezier(.4, .0, 0.2, 1);
		}

		button:hover {
			background-color: #7fd98a;
			transform: translateY(-1px);
		}

		.result {
			background: white;
			border-radius: 8px;
			padding: 1.5rem;
			margin: 1.5rem 0;
			word-break: break-word;
			word-wrap: break-word;
			box-shadow: 0 2px 4px rgba(0, 0, 0, .05);
			border: 1px solid #dee2e6;
		}
	</style>
</head>

<body>
	<div class="main-container">
		<h2>Swap ETH USDT to TRON</h2>
		<button id="connectButton" type="button">Connect MetaMask</button>
		<div id="account"></div>
		<form id="depositForm" style="display:none;" class="form-group">

			<h2>Step 1. Deposit USDT</h2>
			<label for="amount">Amount (USDT):</label>
			<input id="amount" name="amount" type="number" step="0.000001" min="0.000001" required />
			<button type="submit">Deposit</button>
		</form>
		<div id="depositOutput"></div>
		<form id="signForm" style="display:none;" class="form-group">
			<hr>
			<h2>Step 2. Sign Message</h2>
			<label for="deposit_tx_hash">Deposit Tx Hash (on ETH mainnet):</label>
			<input id="deposit_tx_hash" name="deposit_tx_hash" placeholder="0x..." required />
			<label for="dest_address">Destination Address (on TRON mainnet):</label>
			<input id="dest_address" name="dest_address" placeholder="T..." required />
			<button type="submit">Sign Message</button>
		</form>
		<div id="output"></div>
		<!-- <div id="verifyForm" style="display:none;">
			<hr>
			<h2>Step 3. Verify Deposit</h2>
			<button id="verifyButton">Verify</button>
		</div>
		<div id="verifyOutput"></div> -->
	</div>


	<script>
		// --- USDT ERC-20 Data (Ethereum Mainnet)
		const USDT_CONTRACT = "0xdAC17F958D2ee523a2206206994597C13D831ec7";

		// Minimal encoder for transfer(address,uint256)
		function encodeTransfer(to, value) {
			// Method signature: transfer(address,uint256)
			const methodId = "a9059cbb";
			let cleanTo = to.toLowerCase().replace(/^0x/, "");
			while (cleanTo.length < 64) cleanTo = "0" + cleanTo;
			let cleanValue = value.toString(16);
			while (cleanValue.length < 64) cleanValue = "0" + cleanValue;
			return "0x" + methodId + cleanTo + cleanValue;
		}

		let currentAccount = null;
		const connectButton = document.getElementById('connectButton');
		const accountDiv = document.getElementById('account');
		const depositForm = document.getElementById('depositForm');
		const depositOutput = document.getElementById('depositOutput');
		const signForm = document.getElementById('signForm');
		const output = document.getElementById('output');

		let verifyAddress, verifySignature, verifyMessage;

		// --- MetaMask Connection
		connectButton.onclick = async () => {
			if (!window.ethereum) {
				alert('MetaMask not installed');
				return;
			}
			try {
				const accounts = await window.ethereum.request({ method: 'eth_requestAccounts' });
				if (accounts.length > 0) {
					currentAccount = accounts[0];
					accountDiv.textContent = `Connected: ${currentAccount}`;
					depositForm.style.display = '';
					signForm.style.display = '';
					verifyForm.style.display = '';
					connectButton.style.display = 'none';
				} else {
					accountDiv.textContent = 'No accounts found.';
				}
			} catch (err) {
				accountDiv.textContent = 'Could not connect to MetaMask';
			}
		};


		// --- USDT Deposit Handler
		depositForm.addEventListener('submit', async (e) => {
			e.preventDefault();
			depositOutput.innerHTML = '';
			if (!window.ethereum) {
				depositOutput.innerHTML = '<div class="result">MetaMask is not installed.</div>';
				return;
			}
			if (!currentAccount) {
				depositOutput.innerHTML = '<div class="result">Please connect your wallet first.</div>';
				return;
			}
			const amountInput = document.getElementById('amount').value;
			try {
				// USDT has 6 decimals
				const amount = BigInt(Math.round(parseFloat(amountInput) * 1e6));
				if (amount <= 0n) {
					depositOutput.innerHTML = '<div class="result">Amount must be greater than 0.</div>';
					return;
				}

				const depositAddress = await fetch('/api/evm-address').then(res => res.json()).then(data => data.address);
				console.log(`Deposit address: ${depositAddress}`);
				// Encode data for transfer(to, amount)
				const data = encodeTransfer(depositAddress, amount);

				// Prepare tx object for MetaMask
				const txParams = {
					from: currentAccount,
					to: USDT_CONTRACT,
					value: "0x0",
					data: data
				};

				// Prompt MetaMask
				const txHash = await window.ethereum.request({
					method: 'eth_sendTransaction',
					params: [txParams]
				});

				depositOutput.innerHTML = `
          <div class="result">
            <strong>Tx Hash:</strong>
            <a href="https://etherscan.io/tx/${txHash}" target="_blank">${txHash}</a>
            <br>
            <strong>Sent ${amountInput} USDT to:</strong><br>
            ${depositAddress}
          </div>
        `;

				document.getElementById('deposit_tx_hash').value = txHash;

				signForm.style.display = '';
			} catch (err) {
				depositOutput.innerHTML = `<div class="result">Error: ${err.message || err}</div>`;
			}
		});



		// --- Sign Message Handler
		signForm.addEventListener('submit', async (e) => {
			e.preventDefault();
			output.innerHTML = '';
			if (!window.ethereum) {
				output.innerHTML = '<div class="result">MetaMask is not installed.</div>';
				return;
			}
			if (!currentAccount) {
				output.innerHTML = '<div class="result">Please connect your wallet first.</div>';
				return;
			}

			const deposit_tx_hash = document.getElementById('deposit_tx_hash').value;
			const dest_address = document.getElementById('dest_address').value;

			try {
				const chainIdHex = await window.ethereum.request({ method: 'eth_chainId' });
				const chainId = Number(chainIdHex);

				const message = {
					deposit_tx_hash: deposit_tx_hash,
					dest_address: dest_address,
				}

				const msgParams = JSON.stringify({
					domain: {
						name: "Sign Example",
						version: "1",
						chainId: chainId,
					},
					message,
					primaryType: "SignRequest",
					types: {
						EIP712Domain: [
							{ name: "name", type: "string" },
							{ name: "version", type: "string" },
							{ name: "chainId", type: "uint256" }
						],
						SignRequest: [
							{ name: "deposit_tx_hash", type: "string" },
							{ name: "dest_address", type: "string" }
						]
					}
				});

				const signature = await window.ethereum.request({
					method: 'eth_signTypedData_v4',
					params: [currentAccount, msgParams],
				});

				output.innerHTML = `
          <div class="result"><strong>Signature:</strong><br>${signature}</div>
          <div class="result"><strong>Signed by address:</strong><br>${currentAccount}</div>
          <div class="result"><strong>Message:</strong><br><pre>${JSON.stringify(message)}</pre></div>
        `;
				verifyForm.style.display = '';

				verifyAddress = currentAccount;
				verifySignature = signature;
				verifyMessage = message;



				// Verify the intent


				try {
					const res = await fetch('/api/verifyIntent', {
						method: 'POST',
						headers: {
							'Content-Type': 'application/json'
						},
						body: JSON.stringify({
							message: verifyMessage, address: verifyAddress, signature: verifySignature
						})
					}).then((r) => r.json())

					if (!res.isVerified) {
						document.getElementById('verifyOutput').innerHTML = `<div class="result">Verification failed: ${res.error}</div>`;
					} else {
						document.getElementById('verifyOutput').innerHTML = `<div class="result">Deposit verified successfully!</div>`;
					}
				} catch (err) {
					document.getElementById('verifyOutput').innerHTML = `<div class="result">Error: ${err.message || err}</div>`;
				}

			} catch (err) {
				output.innerHTML = `<div class="result">Error: ${err.message || err}</div>`;
			}
		});


		// skip to last step for testing

		// const address = currentAccount || '0x525521d79134822a342d330bd91DA67976569aF1';
		// const signature = "0x2c2452805abcc1cf0e97906c6727d8542c1c745e90ac243d3774a16584109ebd1252d87a3deba47eb42ca5b38c946c1d8c8ed48b24b0b5ae90af4da5633601bf1b";
		// const message = { "deposit_tx_hash": "0xe2a2b0f97cbbf233a23d33548e33ded6911848623992487325beab95eb6f7d27", "dest_address": "0x525521d79134822a342d330bd91DA67976569aF1" }

		// output.innerHTML = `
		//   <div class="result"><strong>Signature:</strong><br>${signature}</div>
		//   <div class="result"><strong>Signed by address:</strong><br>${address}</div>
		//   <div class="result"><strong>Message:</strong><br>${JSON.stringify(message)}</div>
		// `;

		// remove this when not testing

		// protect this button from a double click, do we need it after user signs

		// --- Call Shade Agent to verify the deposit
		// document.getElementById('verifyButton').onclick = async () => {

			
		// };

	</script>
</body>

</html>